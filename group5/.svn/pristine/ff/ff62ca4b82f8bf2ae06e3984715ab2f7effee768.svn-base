/* 최초 세팅 예약번호 생성 + 좌석테이블 hide */
$(function() {
	$("#seatTable").hide();
	$.ajax({
		url : './rc',
		type : 'post',
		data : {
			nextSt : "cfmNumCre"
		},
	}).done(function(result) {
		$("#cfmNum").text(result);
	});
	/* 다시조회 : 페이지 리로드 */
	$("#reloadBtn").on("click", function() {
		sessionStorage.clear();
		window.location.reload();
	});

	/* 날짜설정 */
	var result_a = new Date().toISOString().split("T");
	var today = result_a[0];
	document.getElementById("viewDate").value = today;
	document.getElementById("viewDate").setAttribute("min", today);
	document.getElementById("viewDate").setAttribute("max", "2021-09-24");
	
	function load() {
		if(sessionStorage.getItem('viewDate') != null) {
			
			var viewD = sessionStorage.getItem('viewDate');
			var viewT = sessionStorage.getItem('viewTime');
			
			$("#viewDate").val(viewD);
			$("#viewTime").val(viewT);
			
			sessionStorage.clear();
		};
	};
	load();
	
	
});

/* 좌석정보 조회 ajax */
$("#seatBtn").on("click", function(e) {
	e.preventDefault();
	$("#seatBtn").attr("disabled", true);
	$("#seatTable").show();
	var moviNum = $("input[name=moviNum]").val();
	var viewDate = $("input[name=viewDate]").val();
	var viewTime = $("select[name=viewTime]").val();

	$.ajax({
		url : './rc',
		type : 'post',
		data : {
			nextSt : "seatStatus",
			viewDate : viewDate,
			viewTime : viewTime,
			moviNum : moviNum
		},
	}).done(function(result) {
		/* result는 String 형태로 값이 가져와짐.... 1,3,22,23 */
		var a = result.split(',');

		var numbers = "";
		for (let i = 0; i < a.length; i++) {
			if (i == (a.length - 1)) {
				numbers += a[i].replace(/[^0-9]/g, '');
			} else {
				numbers += a[i].replace(/[^0-9]/g, '') + ",";
			}
			;
		}
		;
		/* b 배열에 넘버로만 구분된 숫자값을 담아보자 */
		var b = numbers.split(',');
		/* 점유된 좌석에 대해 음영처리 */
		takenSeat(b);
	});
});
/* 추출된 seatNum 점유 표시용 + 좌석 선택 링크 비활성화 로직 */
function takenSeat(b) {
	for (let i = 0; i < b.length; i++) {
		$("#t" + b[i]).css("background-color", "rgba(255,255,255,0.3)");
		$("#a" + b[i]).css('pointer-events', 'none');
	}
	;
};

function tkCfm(param) {

	var seatNum = param;
	var moviNum = $("input[name=moviNum]").val();
	var moviName = $("input[name=moviName]").val();
	var cfmNum = $("#cfmNum").text();
	var scheduleNum = $("#scheduleNum").text();
	var viewDate = $("input[name=viewDate]").val();
	var viewTime = $("select[name=viewTime]").val();
	var email = $("input[name=email]").val();

	var answer = confirm("[예약 정보 확인] 1)영화명 : " + moviName + ", 2)예약번호 : "
			+ cfmNum + ", 3)스케쥴번호 : " + scheduleNum + ", 4)상영날짜 : " + viewDate
			+ ", 5)상영시간 : " + viewTime + ", 6)좌석번호 : " + seatNum);
	if (answer) {
		alert("예약이 완료되었습니다.")

		$
				.ajax({
					url : './rc',
					type : 'post',
					data : {
						nextSt : "tkCfm",
						moviNum : moviNum,
						moviName : moviName,
						cfmNum : cfmNum,
						scheduleNum : scheduleNum,
						seatNum : seatNum,
						viewDate : viewDate,
						viewTime : viewTime,
						email : email
					},
				})
				.done(
						function() {
							var answer2 = confirm("추가 예약을 원하시면 확인 버튼을 눌러주세요. 취소하시면 mypage로 돌아갑니다.")

							if (answer2) {
								
								function save() {
									sessionStorage.setItem('viewDate', viewDate);
									sessionStorage.setItem('viewTime',  viewTime);
								};
								save();
								window.location.reload();

							} else {
								window.location.href = "./rc?nextSt=mypage";
							}
						});
	}
};

